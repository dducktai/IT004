CREATE DATABASE KTCUOIKI_22521270;
USE KTCUOIKI_22521270
SET DATEFORMAT DMY  

--Cau 1:
CREATE TABLE KHACHHANG(
	MAKH CHAR(4) PRIMARY KEY, --Mã khách hàng 
	HOTEN VARCHAR(40), --Họ và tên khách hàng 
	SODT VARCHAR(20), --Số điện thoại khách hàng 
	NGSINH SMALLDATETIME, --Ngày sinh
	DIEMTHUONG INT, --Số điểm hiện có (còn lại sau khi sử dụng) từ việc mua hàng tích điểm  
	DIEMSD INT, --Số tích điểm đã được sử dụng 
	DOANHSO MONEY --Tổng giá trị các hóa đơn khách hàng đã mua 
)
GO
CREATE TABLE NHANVIEN(
	MANV CHAR(4) PRIMARY KEY, --Mã nhân viên 
	HOTEN VARCHAR(40), --Họ và tên nhân viên 
	SODT VARCHAR(20), --Số điện thoại nhân viên 
	NGVL SMALLDATETIME --Ngày vào làm 
)
GO 
CREATE TABLE SANPHAM(
	MASP CHAR(4) PRIMARY KEY, --Mã sản phẩm 
	TENSP VARCHAR(40), --Tên sản phẩm 
	DVT VARCHAR(20), --Đơn vị tính 
	GIA MONEY, --Giá sản phẩm (đã bao gồm các loại thuế)
	NUOCSX VARCHAR(40), --Tên nước sản xuất 
	NHASX VARCHAR(20) --Tên nhà sản xuất 
)
GO 
CREATE TABLE HOADON(
	SOHD INT PRIMARY KEY, --Số hóa đơn duy nhất cho mỗi hóa đơn 
	NGHD SMALLDATETIME, --Ngày hóa đơn 
	MAKH CHAR(4) FOREIGN KEY REFERENCES KHACHHANG (MAKH), --Mã khách hàng 
	MANV CHAR(4) FOREIGN KEY REFERENCES NHANVIEN (MANV), --Mã nhân viên 
	THUE MONEY, --Tiền thuế (các phần trăm thuế đã được quy đổi ra tiền)
	TRIGIA MONEY, --Tổng trị giá của hóa đơn (đã bao gồm thuế)
	TONGSL INT --Tổng số lượng tất cả các sản phẩm đã mua 
)
GO
CREATE TABLE CTHD(
	SOHD INT FOREIGN KEY REFERENCES HOADON (SOHD), --Số hóa đơn 
	MASP CHAR(4) FOREIGN KEY REFERENCES SANPHAM (MASP), --Mã sản phẩm 
	SL INT --Số lượng từng sản phẩm 
	CONSTRAINT CTHD_PK PRIMARY KEY(SOHD, MASP)
)

INSERT INTO KHACHHANG VALUES ('KH01','Dang Duc Tai','0987654321','09/11/2004','98765','33000','16444000')
INSERT INTO KHACHHANG VALUES ('KH02','Le Trung Thien','0901122334','12/03/2003','23456','36000','54678000')
INSERT INTO KHACHHANG VALUES ('KH03','Le Minh Quan','0888777666','26/02/2004','56789','22100','8572000')
INSERT INTO KHACHHANG VALUES ('KH04','Lai Quan Thien','0912345678','15/01/2004','12345','40800','73974000')
INSERT INTO KHACHHANG VALUES ('KH05','Le Thi Hoang Kieu','0978888999','10/10/1992','87654','55000','51566000')
INSERT INTO KHACHHANG VALUES ('KH06','Le Bao An','0845678901','23/04/1995','54321','23400','45089000')
INSERT INTO KHACHHANG VALUES ('KH07','Nguyen Duc Tan','0965432109','16/09/1997','78900','59600','16570000')
INSERT INTO KHACHHANG VALUES ('KH08','Mai Ngo Thien Phu','0898765432','03/08/1984','87654','52000','79841000')
INSERT INTO KHACHHANG VALUES ('KH09','Le Tien Tam','0954321890','28/01/1980','34567','16200','21091000')
INSERT INTO KHACHHANG VALUES ('KH10','Tran Xuan Toan','0876543210','20/03/1986','45678','27500','83873000')
INSERT INTO KHACHHANG VALUES ('KH11','Le Minh Tuan','0932109876','03/11/2004','89012','14900','27121000')
INSERT INTO KHACHHANG VALUES ('KH12','Duong Tat Thanh','0867530981','20/05/1986','54321','48000','20093000')
INSERT INTO KHACHHANG VALUES ('KH13','Le Cao Thang','0943210657','19/08/1987','87654','22000','47989000')
INSERT INTO KHACHHANG VALUES ('KH14','Dang Phuong Thuy','0823456789','14/07/1981','23456','59000','52632000')
INSERT INTO KHACHHANG VALUES ('KH15','Nguyen Thu Trang','0987654321','06/03/1995','98765','45700','14024000')
INSERT INTO KHACHHANG VALUES ('KH16','Nguyen Thuy Trang','0901122334','06/03/1997','56789','31800','44421000')
INSERT INTO KHACHHANG VALUES ('KH17','Nguyen Cat Anh','0888777666','29/12/1991','12345','51200','24933000')
INSERT INTO KHACHHANG VALUES ('KH18','Pham Duy Anh','0912345678','25/04/1995','67890','56000','4537000')
INSERT INTO KHACHHANG VALUES ('KH19','Pham Thi Phuong Anh','0978888999','31/01/1996','45678','18500','56341000')
INSERT INTO KHACHHANG VALUES ('KH20','Trinh Minh Anh','0845678901','28/10/1980','78900','41100','53067000')

INSERT INTO NHANVIEN VALUES ('NV01','Vo Minh Hieu','0927345678','23/04/2018')
INSERT INTO NHANVIEN VALUES ('NV02','Doan Trong Nghia','0987567390','09/03/2019')
INSERT INTO NHANVIEN VALUES ('NV03','Cao Thi Minh Thuy','0997047382','10/09/2022')
INSERT INTO NHANVIEN VALUES ('NV04','Nguyen Cao Thang','0913758498','25/06/2018')
INSERT INTO NHANVIEN VALUES ('NV05','Phan Hien Dung','0918590387','10/02/2022')
INSERT INTO NHANVIEN VALUES ('NV06','Nguyen Ngoc Chau','0918590388','19/04/2022')
INSERT INTO NHANVIEN VALUES ('NV07','Hoang Vu Khanh Trang','0918590389','16/12/2021')
INSERT INTO NHANVIEN VALUES ('NV08','Nguyen Thi Thu Hien','0918590390','12/10/2018')
INSERT INTO NHANVIEN VALUES ('NV09','Tran Thanh Huyen','0918590391','05/08/2018')
INSERT INTO NHANVIEN VALUES ('NV10','Dang Thi Oanh','0918590392','19/01/2020')
INSERT INTO NHANVIEN VALUES ('NV11','Tran Thi Yen Vy','0918590393','25/12/2021')
INSERT INTO NHANVIEN VALUES ('NV12','Nguyen Pham Ha My','0918590394','07/05/2022')
INSERT INTO NHANVIEN VALUES ('NV13','Le Thi Hien Trang','0918590395','17/03/2018')
INSERT INTO NHANVIEN VALUES ('NV14','Nguyen Tan Dung','0918590396','01/10/2022')
INSERT INTO NHANVIEN VALUES ('NV15','Tran Thi Van','0918590397','25/06/2021')
INSERT INTO NHANVIEN VALUES ('NV16','Hoang Bich Khoi','0918590398','23/09/2020')
INSERT INTO NHANVIEN VALUES ('NV17','Bui Hong Anh','0918590399','02/06/2020')
INSERT INTO NHANVIEN VALUES ('NV18','Le Thi My Duyen','0918590400','28/08/2019')
INSERT INTO NHANVIEN VALUES ('NV19','Nguyen Hoang Thuy Vy','0918590401','18/10/2020')
INSERT INTO NHANVIEN VALUES ('NV20','Vu Duc Huy','0918590402','23/06/2023')
INSERT INTO NHANVIEN VALUES ('NV21','Nguyen Trung Kien','0918590403','24/01/2022')
INSERT INTO NHANVIEN VALUES ('NV22','Le Duy Khiem','0918590404','02/12/2019')
INSERT INTO NHANVIEN VALUES ('NV23','Nguyen Minh Khue','0918590405','20/07/2023')
INSERT INTO NHANVIEN VALUES ('NV24','Bui Hai Lam','0918590406','28/01/2021')
INSERT INTO NHANVIEN VALUES ('NV25','Nguyen Ha Gia Linh','0918590407','17/07/2021')

INSERT INTO SANPHAM VALUES ('BC01','But chi','cay','3000','Singapore','ThienLong')
INSERT INTO SANPHAM VALUES ('BC02','But chi','cay','5000','Singapore','ThienLong')
INSERT INTO SANPHAM VALUES ('BC03','But chi','cay','3500','Viet Nam','ThienLong')
INSERT INTO SANPHAM VALUES ('BC04','But chi','hop','30000','Viet Nam','ThienLong')
INSERT INTO SANPHAM VALUES ('BB01','But bi','cay','5000','Viet Nam','ThienLong')
INSERT INTO SANPHAM VALUES ('BB02','But bi','cay','7000','Trung Quoc','ThienLong')
INSERT INTO SANPHAM VALUES ('BB03','But bi','hop','100000','Thai Lan','ThienLong')
INSERT INTO SANPHAM VALUES ('TV01','Tap 100 giay mong','quyen','2500','Trung Quoc','ThienLong')
INSERT INTO SANPHAM VALUES ('TV02','Tap 200 giay mong','quyen','4500','Trung Quoc','ThienLong')
INSERT INTO SANPHAM VALUES ('TV03','Tap 100 giay tot','quyen','3000','Viet Nam','ThienLong')
INSERT INTO SANPHAM VALUES ('TV04','Tap 200 giay tot','quyen','5500','Viet Nam','ThienLong')
INSERT INTO SANPHAM VALUES ('TV05','Tap 100 trang','chuc','23000','Viet Nam','ThienLong')
INSERT INTO SANPHAM VALUES ('TV06','Tap 200 trang','chuc','53000','Viet Nam','ThienLong')
INSERT INTO SANPHAM VALUES ('TV07','Tap 100 trang','chuc','34000','Trung Quoc','ThienLong')
INSERT INTO SANPHAM VALUES ('ST01','So tay 500 trang','quyen','40000','Trung Quoc','ThienLong')
INSERT INTO SANPHAM VALUES ('ST02','So tay loai 1','quyen','55000','Viet Nam','ThienLong')
INSERT INTO SANPHAM VALUES ('ST03','So tay loai 2','quyen','51000','Viet Nam','ThienLong')
INSERT INTO SANPHAM VALUES ('ST04','So tay','quyen','55000','Thai Lan','ThienLong')
INSERT INTO SANPHAM VALUES ('ST05','So tay mong','quyen','20000','Thai Lan','ThienLong')
INSERT INTO SANPHAM VALUES ('ST06','Phan viet bang','hop','5000','Viet Nam','ThienLong')
INSERT INTO SANPHAM VALUES ('ST07','Phan khong bui','hop','7000','Viet Nam','ThienLong')
INSERT INTO SANPHAM VALUES ('ST08','Bong bang','cai','1000','Viet Nam','ThienLong')
INSERT INTO SANPHAM VALUES ('ST09','But long','cay','5000','Viet Nam','ThienLong')
INSERT INTO SANPHAM VALUES ('ST10','But long','cay','7000','Trung Quoc','ThienLong')
INSERT INTO SANPHAM VALUES ('ST11','Bot giat','hop','70000','Trung Quoc','OMO')

INSERT INTO HOADON VALUES('1','05/05/2020','KH01','NV14','33000','90659000','35')
INSERT INTO HOADON VALUES('2','13/01/2019','KH14','NV20','36000','99143000','12')
INSERT INTO HOADON VALUES('3','01/10/2018','KH09','NV20','22100','78381000','42')
INSERT INTO HOADON VALUES('4','20/11/2018','KH05','NV21','40800','42426000','28')
INSERT INTO HOADON VALUES('5','07/03/2022','KH17','NV08','55000','84513000','18')
INSERT INTO HOADON VALUES('6','20/02/2023','KH02','NV19','23400','38095000','49')
INSERT INTO HOADON VALUES('7','06/10/2018','KH12','NV06','59600','86469000','22')
INSERT INTO HOADON VALUES('8','15/07/2023','KH20','NV18','52000','2883000','15')
INSERT INTO HOADON VALUES('9','28/05/2020','KH18','NV21','16200','27456000','37')
INSERT INTO HOADON VALUES('10','19/04/2021','KH10','NV07','27500','78124000','31')
INSERT INTO HOADON VALUES('11','11/12/2018','KH03','NV09','14900','29944000','50')
INSERT INTO HOADON VALUES('12','17/05/2019','KH08','NV04','48000','50273000','11')
INSERT INTO HOADON VALUES('13','17/12/2020','KH15','NV16','22000','29995000','48')
INSERT INTO HOADON VALUES('14','13/12/2021','KH16','NV22','59000','95846000','24')
INSERT INTO HOADON VALUES('15','06/05/2018','KH06','NV13','45700','13624000','44')
INSERT INTO HOADON VALUES('16','28/04/2021','KH11','NV16','31800','49852000','19')
INSERT INTO HOADON VALUES('17','11/03/2019','KH07','NV17','51200','62117000','33')
INSERT INTO HOADON VALUES('18','31/12/2020','KH04','NV20','56000','19295000','26')
INSERT INTO HOADON VALUES('19','01/06/2020','KH13','NV03','18500','97604000','14')
INSERT INTO HOADON VALUES('20','30/03/2021','KH19','NV17','41100','6268000','40')
INSERT INTO HOADON VALUES('21','10/07/2021','KH01','NV15','33000','85681000','30')
INSERT INTO HOADON VALUES('22','04/02/2022','KH14','NV14','36000','30496000','45')
INSERT INTO HOADON VALUES('23','10/03/2022','KH09','NV10','22100','59970000','29')
INSERT INTO HOADON VALUES('24','25/03/2018','KH05','NV06','40800','55661000','13')
INSERT INTO HOADON VALUES('25','09/12/2020','KH17','NV24','55000','51660000','38')
INSERT INTO HOADON VALUES('26','30/06/2018','KH02','NV04','23400','42960000','21')
INSERT INTO HOADON VALUES('27','21/01/2019','KH12','NV08','59600','4994000','46')
INSERT INTO HOADON VALUES('28','30/08/2023','KH20','NV20','52000','62667000','16')
INSERT INTO HOADON VALUES('29','20/11/2020','KH18','NV12','16200','23855000','41')
INSERT INTO HOADON VALUES('30','04/01/2022','KH10','NV21','27500','21390000','23')
INSERT INTO HOADON VALUES('31','04/10/2018','KH03','NV04','14900','68012000','36')
INSERT INTO HOADON VALUES('32','21/09/2022','KH08','NV07','48000','11880000','17')
INSERT INTO HOADON VALUES('33','17/09/2022','KH15','NV07','22000','33985000','43')
INSERT INTO HOADON VALUES('34','14/09/2022','KH16','NV08','59000','85777000','27')
INSERT INTO HOADON VALUES('35','20/09/2021','KH06','NV08','45700','87619000','32')
INSERT INTO HOADON VALUES('36','28/07/2020','KH11','NV16','31800','36990000','47')
INSERT INTO HOADON VALUES('37','08/01/2023','KH07','NV19','51200','42563000','25')
INSERT INTO HOADON VALUES('38','02/03/2020','KH04','NV12','56000','20822000','39')
INSERT INTO HOADON VALUES('39','28/09/2021','KH13','NV13','18500','33985000','20')
INSERT INTO HOADON VALUES('40','07/02/2022','KH19','NV08','41100','38785000','34')
INSERT INTO HOADON VALUES('41','23/08/2022','KH01','NV24','33000','55355000','10')
INSERT INTO HOADON VALUES('42','04/07/2019','KH14','NV03','36000','13254000','49')
INSERT INTO HOADON VALUES('43','28/02/2019','KH09','NV19','22100','3578000','11')
INSERT INTO HOADON VALUES('44','29/08/2020','KH05','NV14','40800','42902000','37')
INSERT INTO HOADON VALUES('45','18/11/2019','KH17','NV01','55000','56459000','12')
INSERT INTO HOADON VALUES('46','14/04/2018','KH02','NV04','23400','89302000','28')
INSERT INTO HOADON VALUES('47','01/04/2019','KH12','NV20','59600','67980000','44')
INSERT INTO HOADON VALUES('48','18/10/2022','KH20','NV11','52000','31428000','19')
INSERT INTO HOADON VALUES('49','17/12/2020','KH18','NV18','16200','67850000','30')
INSERT INTO HOADON VALUES('50','04/09/2021','KH10','NV20','27500','72482000','15')

INSERT INTO CTHD VALUES('1','ST08','60')
INSERT INTO CTHD VALUES('1','TV02','10')
INSERT INTO CTHD VALUES('1','BC04','69')
INSERT INTO CTHD VALUES('2','ST01','5')
INSERT INTO CTHD VALUES('3','BC01','5')
INSERT INTO CTHD VALUES('4','BC02','10')
INSERT INTO CTHD VALUES('4','BC01','71')
INSERT INTO CTHD VALUES('5','ST08','10')
INSERT INTO CTHD VALUES('5','BC04','93')
INSERT INTO CTHD VALUES('6','BC04','20')
INSERT INTO CTHD VALUES('6','BB01','38')
INSERT INTO CTHD VALUES('7','BB01','20')
INSERT INTO CTHD VALUES('7','BB02','70')
INSERT INTO CTHD VALUES('8','BB02','20')
INSERT INTO CTHD VALUES('8','TV02','47')
INSERT INTO CTHD VALUES('9','BB03','10')
INSERT INTO CTHD VALUES('9','TV03','60')
INSERT INTO CTHD VALUES('10','TV01','20')
INSERT INTO CTHD VALUES('10','TV02','97')
INSERT INTO CTHD VALUES('11','TV02','10')
INSERT INTO CTHD VALUES('11','TV04','25')
INSERT INTO CTHD VALUES('11','TV03','33')
INSERT INTO CTHD VALUES('12','TV03','10')
INSERT INTO CTHD VALUES('12','TV04','10')
INSERT INTO CTHD VALUES('12','TV06','68')
INSERT INTO CTHD VALUES('13','TV04','10')
INSERT INTO CTHD VALUES('13','TV07','57')
INSERT INTO CTHD VALUES('13','TV06','54')
INSERT INTO CTHD VALUES('14','TV05','50')
INSERT INTO CTHD VALUES('14','TV04','82')
INSERT INTO CTHD VALUES('14','TV06','18')
INSERT INTO CTHD VALUES('15','TV06','50')
INSERT INTO CTHD VALUES('15','BC02','38')
INSERT INTO CTHD VALUES('15','BB02','63')
INSERT INTO CTHD VALUES('16','BC04','20')
INSERT INTO CTHD VALUES('16','ST01','80')
INSERT INTO CTHD VALUES('17','ST01','30')
INSERT INTO CTHD VALUES('17','ST02','43')
INSERT INTO CTHD VALUES('18','ST02','10')
INSERT INTO CTHD VALUES('18','ST03','2')
INSERT INTO CTHD VALUES('19','ST03','10')
INSERT INTO CTHD VALUES('19','ST04','30')
INSERT INTO CTHD VALUES('20','ST04','8')
INSERT INTO CTHD VALUES('21','ST05','10')
INSERT INTO CTHD VALUES('22','TV07','50')
INSERT INTO CTHD VALUES('23','ST07','50')
INSERT INTO CTHD VALUES('24','ST08','100')
INSERT INTO CTHD VALUES('25','ST04','50')
INSERT INTO CTHD VALUES('25','BC01','99')
INSERT INTO CTHD VALUES('25','BC02','83')
INSERT INTO CTHD VALUES('25','TV03','90')
INSERT INTO CTHD VALUES('26','TV03','100')
INSERT INTO CTHD VALUES('26','TV04','81')
INSERT INTO CTHD VALUES('26','TV05','65')
INSERT INTO CTHD VALUES('26','TV06','41')
INSERT INTO CTHD VALUES('27','ST06','50')
INSERT INTO CTHD VALUES('27','ST04','34')
INSERT INTO CTHD VALUES('27','ST05','63')
INSERT INTO CTHD VALUES('27','TV07','70')
INSERT INTO CTHD VALUES('28','BC01','3')
INSERT INTO CTHD VALUES('28','ST06','98')
INSERT INTO CTHD VALUES('28','ST08','98')
INSERT INTO CTHD VALUES('28','ST04','93')
INSERT INTO CTHD VALUES('29','ST08','5')
INSERT INTO CTHD VALUES('29','BC02','40')
INSERT INTO CTHD VALUES('29','BB02','58')
INSERT INTO CTHD VALUES('29','BC04','25')
INSERT INTO CTHD VALUES('30','BC02','80')
INSERT INTO CTHD VALUES('31','BB02','100')
INSERT INTO CTHD VALUES('32','BC04','60')
INSERT INTO CTHD VALUES('33','BB01','50')
INSERT INTO CTHD VALUES('34','BB02','30')
INSERT INTO CTHD VALUES('35','BB03','7')
INSERT INTO CTHD VALUES('35','BC01','35')
INSERT INTO CTHD VALUES('36','TV01','5')
INSERT INTO CTHD VALUES('36','BC01','75')
INSERT INTO CTHD VALUES('37','TV02','1')
INSERT INTO CTHD VALUES('37','BC01','93')
INSERT INTO CTHD VALUES('38','TV03','1')
INSERT INTO CTHD VALUES('38','BC01','63')
INSERT INTO CTHD VALUES('39','TV04','5')
INSERT INTO CTHD VALUES('39','BC01','87')
INSERT INTO CTHD VALUES('40','ST04','6')
INSERT INTO CTHD VALUES('40','BC01','18')
INSERT INTO CTHD VALUES('41','ST05','1')
INSERT INTO CTHD VALUES('41','BC01','77')
INSERT INTO CTHD VALUES('41','BC02','46')
INSERT INTO CTHD VALUES('42','ST06','2')
INSERT INTO CTHD VALUES('42','BC01','67')
INSERT INTO CTHD VALUES('42','BC03','8')
INSERT INTO CTHD VALUES('43','ST07','10')
INSERT INTO CTHD VALUES('43','BC01','99')
INSERT INTO CTHD VALUES('43','BC02','96')
INSERT INTO CTHD VALUES('44','ST08','5')
INSERT INTO CTHD VALUES('44','ST07','57')
INSERT INTO CTHD VALUES('44','ST06','19')
INSERT INTO CTHD VALUES('45','TV01','7')
INSERT INTO CTHD VALUES('45','BC01','62')
INSERT INTO CTHD VALUES('46','TV02','10')
INSERT INTO CTHD VALUES('47','ST07','1')
INSERT INTO CTHD VALUES('48','ST04','6')
INSERT INTO CTHD VALUES('49','ST05','7')
INSERT INTO CTHD VALUES('49','ST04','37')
INSERT INTO CTHD VALUES('49','ST07','34')
INSERT INTO CTHD VALUES('49','ST06','87')
INSERT INTO CTHD VALUES('50','ST06','8')

--Cau 2: Đơn vị tính phải là cây, hộp, chục, quyển, cái
ALTER TABLE SANPHAM
ADD CONSTRAINT CK_SP_DVT
CHECK (DVT IN ('cay', 'hop', 'chuc', 'quyen', 'cai'));

--Cau 3: Ngày hóa đơn phải lớn hơn hoặc bằng ngày vào làm của nhân viên 
/*
BẢNG RÀNG BUỘC TOÀN VẸN: 
             | Thêm | Xóa |     Sửa     |
   NHANVIEN  |   +  |  -  |   +(NGVL)   |
    HOADON   |   +  |  -  |   +(NGHD)   |

*/
-- INSERT
CREATE TRIGGER CheckNgayBanHang_Insert
ON HOADON
FOR INSERT
AS
BEGIN
    DECLARE 
		@MaNV VARCHAR(10), 
		@NgayVaoLam DATE, 
		@NgayBanHang DATE

    SELECT @MaNV = I.MANV, @NgayBanHang = HD.NGHD
    FROM INSERTED I
    JOIN HOADON HD ON I.SOHD = HD.SOHD

    SELECT @NgayVaoLam = NGVL
    FROM NHANVIEN
    WHERE MANV = @MaNV

    IF (@NgayBanHang < @NgayVaoLam)
    BEGIN
        ROLLBACK TRAN
        RAISERROR ('Ngày bán hàng phải >= ngày vào làm của nhân viên.', 16, 1)
    END
END;

-- UPDATE
CREATE TRIGGER CheckNgayBanHang_Update
ON HOADON
FOR UPDATE
AS
BEGIN
    DECLARE @MaNV VARCHAR(10), @NgayVaoLam DATE, @NgayBanHang DATE

    SELECT @MaNV = I.MANV, @NgayBanHang = H.NGHD
    FROM INSERTED I
    INNER JOIN HOADON H ON I.SOHD = H.SOHD

    SELECT @NgayVaoLam = NGVL
    FROM NHANVIEN
    WHERE MANV = @MaNV

    IF @NgayBanHang < @NgayVaoLam
    BEGIN
        ROLLBACK TRAN
        RAISERROR ('Ngày bán hàng phải >= ngày vào làm của nhân viên.', 16, 1)
    END
END;

--Cau 4: 
SELECT *
FROM KHACHHANG KH
JOIN HOADON HD ON KH.MAKH = HD.MAKH
JOIN CTHD ON HD.SOHD = CTHD.SOHD
JOIN SANPHAM SP ON CTHD.MASP = SP.MASP
WHERE (TENSP LIKE 'C%') OR (TENSP LIKE '%kẹo'); 

--Cau 5:
SELECT TOP 10 SP.MASP, TENSP, SUM(CT.SL) AS SoLuongDaBan 
FROM SANPHAM SP
JOIN CTHD CT ON SP.MASP = CT.MASP
JOIN HOADON HD ON CT.SOHD = HD.SOHD
WHERE YEAR(HD.NGHD) = 2023
GROUP BY SP.MASP, SP.TENSP
ORDER BY SoLuongDaBan DESC;

--Cau 6:
SELECT TOP 1 WITH TIES KH.MAKH, HOTEN, SODT, SUM(HD.TRIGIA) AS TONGTIEN
FROM KHACHHANG KH
JOIN HOADON HD ON KH.MAKH = HD.MAKH
WHERE YEAR(HD.NGHD) = 2023
GROUP BY KH.MAKH, KH.HOTEN, KH.SODT
ORDER BY TONGTIEN DESC;

--Cau 7:
--a
UPDATE KHACHHANG
SET DIEMTHUONG = (
    CASE
        WHEN (DOANHSO BETWEEN 1000000 AND 20000000) THEN (DOANHSO/1000000) * 100
		ELSE 0
    END
)

--b
UPDATE KHACHHANG
SET DIEMTHUONG = (
    CASE
        WHEN (DOANHSO > 20000000) THEN (DOANHSO/ 1000000) * 110
		ELSE 0 
    END
)

--Cau 8:
SELECT TOP 3 MAKH, HOTEN, SODT, DIEMTHUONG
FROM KHACHHANG
ORDER BY DIEMTHUONG DESC;

--Cau 9:
SELECT KH.MAKH, KH.HOTEN
FROM KHACHHANG KH
WHERE NOT EXISTS (
	SELECT *
	FROM SANPHAM SP
	WHERE NHASX = 'OMO' AND NOT EXISTS (
		SELECT *
		FROM HOADON HD
		JOIN CTHD ON HD.SOHD = CTHD.SOHD
		WHERE KH.MAKH = HD.MAKH AND SP.MASP = CTHD.MASP
	)
)



